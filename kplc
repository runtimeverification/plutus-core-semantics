#!/usr/bin/env bash

set -euo pipefail
shopt -s extglob

notif() { echo "== $@" >&2 ; }
fatal() { echo "[FATAL] $@" ; exit 1 ; }

check_k_install() {
    which kast &> /dev/null \
        || fatal "Must have K installed! See https://github.com/kframework/k/releases."
    which krun &> /dev/null \
        || fatal "Must have K installed! See https://github.com/kframework/k/releases."
}

INSTALL_BIN="$(cd $(dirname $0) && pwd)"
INSTALL_LIB="$(dirname ${INSTALL_BIN})/lib/kplutus"
INSTALL_INCLUDE=${INSTALL_LIB}/include

install_k_bin=${INSTALL_LIB}/kframework/bin
plugin_include=${INSTALL_LIB}/blockchain-k-plugin/include

export PATH="${INSTALL_BIN}:${INSTALL_LIB}:${install_k_bin}:${PATH}"

export K_OPTS="${K_OPTS:--Xmx16G -Xss512m}"

# Runners
# -------

# none yet

# Main
# ----

run_command="$1" ; shift

if [[ "$run_command" == 'help' ]] || [[ "$run_command" == '--help' ]] ; then
    echo "
        usage: $0 [help|--help|version|--version]

           $0 help    : Display this help message.
           $0 version : Display the versions of KPlutus.
    "
    exit 0
fi

if [[ "$run_command" == 'version' ]] || [[ "$run_command" == '--version' ]]; then
    notif 'KPlutus Version'
    cat $INSTALL_LIB/version
    exit 0
fi

backend='llvm'
debug=false
args=()
while [[ $# -gt 0 ]]; do
    case "$1" in
        --debug)       debug=true ; args+=("$1") ; shift   ;;
        --backend)     backend="$2"              ; shift 2 ;;
        --backend-dir) backend_dir="$2"          ; shift 2 ;;
        *)             args+=("$1")              ; shift   ;;
    esac
done

[[ "${#args[@]}" -le 0 ]] || set -- "${args[@]}"
backend_dir="${backend_dir:-$INSTALL_LIB/$backend}"

run_file="$1" ; shift
[[ -f "$run_file" ]] || fatal "File does not exist: $run_file"

! ${debug} || set -x

case "$run_command-$backend" in
    *) $0 help ; fatal "Unknown command on backend: $run_command $backend" ;;
esac
