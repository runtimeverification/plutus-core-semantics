KPlutus - K Semantics of Plutus-Core
====================================

Dependencies
------------

-   Install needed K dependencies: <https://github.com/kframework/k>
-   Update submodules: `git submodule update --init --recursive`
-   Make dependencies: `make deps RELEASE=true`

### Ubuntu

```
sudo apt-get install build-essential m4 openjdk-11-jdk libgmp-dev libmpfr-dev pkg-config flex bison z3 libsecp256k1-dev libz3-dev maven python3 python3-pip cmake gcc clang-10 lld-10 llvm-10-tools zlib1g-dev libboost-test-dev libyaml-dev libjemalloc-dev libsecp256k1-dev libssl-dev xxd
pip install virtualenv poetry
```

Building
--------

-   Build everything: `make build -j8`
-   Build LLVM backend: `make build-llvm -j8`
-   Build Haskell backend: `make build-haskell -j8`
-   Build just KPlutus runner and includes: `make build-kplutus -j8`

# A note about Crypto++

Due to a bug in the ubuntu bionic and focal packages for crypto++ that affects us here, we build a static library for it from source.
If you're certain that you have a crypto++ package installed that doesn't have this bug, you can run the make commands with `NOBUILD_CRYPTOPP=true`

Testing
-------

-   Conformance tests: `make conformance-test`
    Runs all tests where an input program is executed by the `kplc run` command.
    The output is compared against the reference implementation as well as a previous run of `kplc run`

-   Simple hand-written tests: `make test-simple`
    These contain small tests that have been written during the development of the semantics.

-   Examples generated by the uplc program: `make test-uplc-examples`
    The uplc program contains several small examples. These are slightly larger programs than files in simple tests.
    The uplc program is a part of the plutus repository https://github.com/input-output-hk/plutus

-   Examples benchmark examples: `test-benchmark-validation-examples`
    This contains many examples derived from the plutus-apps directory. These represent are more realistic plutus programs.
    The tests from this directory were extracted from https://github.com/input-output-hk/plutus/tree/master/plutus-benchmark/validation/data

-   Examples generated by the nofib-exe program: test-nofib-exe-examples
    nofib-exe is a program that generates large programs that can serve as performance tests.
    This program is a part of the plutus repository.

-   Tests that evaluate to an `error` term: `make test-error`

-   Update test results: `make update-results`
    Update all test results. Note: this requires having the uplc program installed in the machine's PATH.

Rule Coverage
-------------

This project contains facilities to generate coverage metrics for K rewrite rules that were executed by `kplc run`.
This is helpful in ensuring that the test suite contains input programs that exercise all rewrite rules in the semantics.

To generate this information, run the following command:

```
  make fresh-test-coverage
```

This command generates a `.build/coverage.xml` file. This file contains information about the K
rewrite rules that have been exercised for all tests in the tests/ directory.

After running `make fresh-test-coverage`, the execution of
`./no-hits.py -r` will show all the rules that have not been exercised
in the last execution of `make fresh-test-coverage`. (By executing
`./no-hits.py -t`, a Python 3 dictionary containing file names and
line numbers is pretty-printed. This dictionary denotes the same as the rules printed with option `-r`.)

Profiling with perf
-------------------

There are build targets for profiling the semantics with perf.

```
make k-deps-profiling
make build-llvm-profiling
```

This will build kplc with optimizations but debug info left in so perf can collect more meaningful data.

You can install perf on ubuntu by installing the `linux-tools-common` package. Information about perf and how to use it
can be found on the [perf wiki](https://perf.wiki.kernel.org/index.php/Main_Page).

Here's an example of steps you can follow to generate and view a report:
```
perf record -g -- kplc run tests/textual/nofib-exe-examples/lastpiece.uplc
```
lastpiece.uplc is a very long running program. You can kill it after about one minute and perf will have collected
a sizeable amount of data.

View the report with
```
perf report -g -c interpreter
```
